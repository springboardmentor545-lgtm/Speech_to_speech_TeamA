# file: scripts/transcribe.py
import os, csv, tempfile, subprocess
import azure.cognitiveservices.speech as speechsdk
from dotenv import load_dotenv

load_dotenv("C:/Users/DELL/front-end/pathi-venkatanihari/speech.env")
SPEECH_KEY, REGION = os.getenv("SPEECH_KEY"), os.getenv("SERVICE_REGION")
speech_config = speechsdk.SpeechConfig(subscription=SPEECH_KEY, region=REGION)

LANGS = {"en": ("en-US", "English"), "hi": ("hi-IN", "Hindi")}
ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
INP, OUT = os.path.join(ROOT, "speech_samples"), os.path.join(ROOT, "transcribe", "transcripts.csv")
os.makedirs(os.path.dirname(OUT), exist_ok=True)

def ensure_wav(path):
    """Ensure file is 16 kHz mono PCM WAV"""
    fixed = os.path.join(tempfile.gettempdir(), os.path.basename(path))
    subprocess.run([
        "ffmpeg", "-y", "-i", path, "-ac", "1", "-ar", "16000",
        "-c:a", "pcm_s16le", fixed
    ], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    return fixed

def transcribe(path, code):
    locale, name = LANGS.get(code, LANGS["en"])
    speech_config.speech_recognition_language = locale
    rec = speechsdk.SpeechRecognizer(
        speech_config=speech_config,
        audio_config=speechsdk.AudioConfig(filename=path)
    )
    res = rec.recognize_once_async().get()
    return res.text if res.reason == speechsdk.ResultReason.RecognizedSpeech else ""

with open(OUT, "w", newline="", encoding="utf-8") as f:
    w = csv.writer(f); w.writerow(["filename", "language", "language_name", "transcript"])
    for fn in sorted(os.listdir(INP)):
        if not fn.endswith(".wav"): continue
        code = "hi" if fn.startswith("dialogue_") else "en"
        fixed = ensure_wav(os.path.join(INP, fn))
        text = transcribe(fixed, code)
        w.writerow([fn, LANGS[code][0], LANGS[code][1], text])
        print(f"âœ… {fn} -> {text}")
print(f"\nğŸ“„ Done! Output: {OUT}")
